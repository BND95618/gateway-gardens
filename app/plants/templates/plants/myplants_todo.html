<!-- /app/plants/templates/plants/plants_about.html -->
{% extends "plants/master.html" %}

{% block title %}
  <title>Gateway Gardens | Todo</title>
{% endblock title %}

{% block css %}
  <!-- Insert template css here -->
  <style>
    a[href*='myplants_todo'] 
    {
      color:            white;
      background-color: slategray; 
    }
  </style>
{% endblock css %}

{% block header-completion %}
  <!-- complete the header from master.html -->
  <header class="bnd-page-banner">
    <h3>
      To Do List
      <span class="bnd-dropdown-hover bnd-right">
        <button class="bnd-button-small">
          <i class="material-icons">menu</i>
        </button>
        <div class="bnd-page-menu bnd-dropdown-content">
          <button onclick="todo_add()"       class="bnd-dropdown-button">Add          </button>
          <button onclick="todo_show_all()"  class="bnd-dropdown-button">Show All     </button>
          <button onclick="todo_hide_done()" class="bnd-dropdown-button">Hide Complete</button>
        </div>
      </span>
    </h3>
  </header>
{% endblock header-completion %}

{% block content %}
  <!------------------------------------->
  <!-- My Plant To Do List Summary     -->
  <!------------------------------------->
  <div class="bnd-content-main-120">
    <table id="todoTable" class="bnd-table">
      <thead>
        <tr>
          <th onclick="todo_sort(1)">Status  </th>
          <th style="display:none" onclick="todo_sort(1)">Status  </th>
          <th onclick="todo_sort(2)">Date    </th>
          <th onclick="todo_sort(3)">My Plant</th>
          <th onclick="todo_sort(4)">Action  </th>
          <th onclick="todo_sort(5)">Repeat  </th>
          <th onclick="todo_sort(6)">Details </th>
          <!-- Button Placeholders -->
          <th class="bnd-table-icon"></th>
          <th class="bnd-table-icon"></th>
        </tr>
      </thead>
      {% for todo in myplants_todo  %}  
        <tbody>
          <tr>
            <!-- To Do complete -->
            <td class="bnd-center">
              <div class="bnd-tooltip">
                <button class="bnd-button-small" onclick="todo_done({{ todo.id }})">
                  <i class="material-icons">
                    {% if todo.complete %}
                      check_box
                    {% else %}
                      check_box_outline_blank
                    {% endif %}
                  </i>
                  <span class="bnd-tooltip-text">Complete?</span>
                </button>
              </div>
            </td>
            <!-- To Do fields -->
            <td class="bnd-hide">{{ todo.complete }}</td>
            <td>{{ todo.date|date:"Y-m-d" }}</td>
            <td>{{ todo.myplant.plant.commonName }}</td>
            <td>{{ todo.action   }}</td>
            <td>{{ todo.repeat   }}</td>
            <td>{{ todo.details  }}</td>
            <!-- To Do edit -->
            <td class="bnd-center">
              <div class="bnd-tooltip">
                <button class="bnd-button-small" onclick="todo_edit({{ todo.id }})">
                  <i class="material-icons">edit</i>
                  <span class="bnd-tooltip-text">Edit</span>
                </button>
              </div>
            </td>
            <!-- To Do delete -->
            <td class="bnd-center">
              <div class="bnd-tooltip">
                <button class="bnd-button-small" onclick="todo_delete({{ todo.id }})">
                  <i class="material-icons">delete</i>
                  <span class="bnd-tooltip-text">Delete</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      {% endfor %}
    </table>
  </div>
  <hr>

  <div class="bnd-container">
    <div class="calendar-container">
      <div class="calendar-header">
        <button id="prevMonth">&#10094;</button>
        <h2 id="monthYear"></h2>
        <button id="nextMonth">&#10095;</button>
      </div>
      <div class="calendar-weekdays">
        <div>Sun</div>
        <div>Mon</div>
        <div>Tue</div>
        <div>Wed</div>
        <div>Thu</div>
        <div>Fri</div>
        <div>Sat</div>
      </div>
      <div class="calendar-dates" id="calendarDates">
          <!-- Dates will be dynamically inserted here by JavaScript -->
      </div>
    </div>
  </div>

  <!-- To Do details modal - html to be inserted by Javascript -->
  <div id="todo_details_modal" class="bnd-modal">
    <p> To Do add form HTML to be Inserted Here! </p>
  </div>

  <!-- To Do add modal - html to be inserted by Javascript -->
  <div id="todo_add_modal" class="bnd-modal">
    <p> To Do add form HTML to be Inserted Here! </p>
  </div>

  <!-- To Do edit modal - html to be inserted by Javascript -->
  <div id="todo_edit_modal" class="bnd-modal">
    <p> To Do edit form HTML to be Inserted Here! </p>
  </div>

  <!-- To Do delete modal - html to be inserted by Javascript -->
  <div id="myplants_todo_del_modal" class="bnd-modal">
    <p> To Do delete form HTML to be Inserted Here! </p>
  </div>

{% endblock content %}

{% block js %}
<script>
    // Get the current my garden ID when Django renders the page
    const myGardenID = {{ myGarden.id }};
    // set initial sort column and direction from db
    let lastToDoSortCol =  {{ myGarden.lastToDoSortCol }};
    let lastToDoSortDir = "{{ myGarden.lastToDoSortDir }}";
        
    function todo_details(id)
    {
        // AR: fix url approach
        url = "/myplants_todo_details/" + id;
        fetch(url) 
        .then(response => response.text())
        .then(html => {todo_details_modal.innerHTML = html;})
        todo_details_modal.style.display='block';
        return;
    }
    function todo_add()  
    {
        url = "{% url 'plants:myplants_todo_add' myGarden.id %}"
        fetch(url) 
        .then(response => response.text())
        .then(html => {todo_add_modal.innerHTML = html;})
        .then(restoreToDoSort())
        todo_add_modal.style.display='block';
    }
    function todo_edit(id)
    {
        // AR: fix url approach
        // url = "{x% url 'plants:myplant_todo_edit' %x}" + "/" + id;

        url = "/myplants_todo_edit/" + id;
        fetch(url) 
        .then(response => response.text())
        .then(html => {todo_edit_modal.innerHTML = html;})
        .then(restoreToDoSort())
        todo_edit_modal.style.display='block';
    }
    function todo_delete(id)
    {
        // AR: fix url approach
        // url = "{x% url 'plants:myplant_todo_del' %x}" + "/" + id;

        url = "/myplants_todo_del/" + id;
        fetch(url) 
        .then(response => response.text())
        .then(html => {myplants_todo_del_modal.innerHTML = html;})
        .then(restoreToDoSort())
        myplants_todo_del_modal.style.display='block';
    }
    function todo_done(id)
    {
        // AR: fix url approach
        // url = "{x% url 'plants:myplant_todo_done' %x}" + "/" + id;

        // 
        const url = "/myplants_todo_done/" + id;
        const requestMethod = "POST";
        const csrfToken     = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const postData = { lastToDoSortCol : lastToDoSortCol,
                           lastToDoSortDir : lastToDoSortDir };

        fetch(url, 
        {
            method: requestMethod,
            headers: 
            {
                // Tells the server that the request body is in JSON format
                'Content-Type': 'application/json',
                //  Provides CSRF protection, necessary for Django
                'X-CSRFToken' : csrfToken
            },
            body: JSON.stringify(postData)
        })
        .then(response => response.text())
        .then(restoreToDoSort());
        window.location.reload()
    }
    function todo_show_all()
    {
        const table = document.getElementById('todoTable');
        const rows  = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) 
        {
            rows[i].style.display = '';
        }
    }
    function todo_hide_done()
    {
        const table = document.getElementById('todoTable');
        const rows  = table.getElementsByTagName("tr");
        const columnIndex = 0;

        for (let i = 1; i < rows.length; i++) 
        {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            const cellValue = cells[columnIndex].textContent.trim();
            const status = cellValue.split('\n')[0];

            if (status == "check_box")
            {
                row.style.display = 'none'; // Hide the row
            } 
            else 
            {
                row.style.display = ''; // Ensure other rows are visible
            }
        }
    }
    function todo_sort(column)
    {
        // sort the table per the specified column
        sortTable(column, 'todoTable');

        // save the column sorted in the script
        lastToDoSortCol = column;

        sortDirection(column);

        // Save sort column and direction to the server db
        const url = "/myplants_todo_save/" + myGardenID;
        const requestMethod = "POST";
        const csrfToken     = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const postData = { lastToDoSortCol : lastToDoSortCol,
                           lastToDoSortDir : lastToDoSortDir };

        fetch(url, 
        {
            method: requestMethod,
            headers: 
            {
                // Tells the server that the request body is in JSON format
                'Content-Type': 'application/json',
                //  Provides CSRF protection, necessary for Django
                'X-CSRFToken' : csrfToken
            },
            body: JSON.stringify(postData)
        })
        .then(response => response.text())
    }
    function restoreToDoSort()  
    {
        // Determine if the table has any rows
        const table = document.getElementById('todoTable');
        const rowCount = table.rows.length;
        if (rowCount > 1)
        {
            // Since the table has rows it is safe to proceed
            let tempSortDirection = "ascending";
            console.log("Got to restoreToDoSort");

            sortTable(lastToDoSortCol, 'todoTable');

            // Determine sort direction
            const rows  = table.getElementsByTagName("tr");

            const firstRow = rows[1];
            const firstRowCells = firstRow.getElementsByTagName('td');
            const firstRowCellContents = firstRowCells[lastToDoSortCol].textContent.trim();
            const firstRowCellValue    = firstRowCellContents .split('\n')[0];

            const lastRow = rows[rows.length - 1];
            const lastRowCells = lastRow.getElementsByTagName('td');
            const lastRowCellContents = lastRowCells[lastToDoSortCol].textContent.trim();
            const lastRowCellValue    = lastRowCellContents .split('\n')[0];

            if( firstRowCellValue < lastRowCellValue )
            {
              tempSortDirection = "up";
            }
            else
            {
              tempSortDirection = "down";
            }

            console.log("lastToDoSortDir  =", lastToDoSortDir);
            console.log("tempSortDirection  =", tempSortDirection);

            if (tempSortDirection != lastToDoSortDir)
            {
              sortTable(lastToDoSortCol, 'todoTable');
            }
        }
    }
    function sortDirection(column)
    {
        // Determine whether the sorted column is ascending or descending
        const table = document.getElementById('todoTable');
        const rows  = table.getElementsByTagName("tr");
        // Get the value contained in the selected column - first data row
        const firstRow = rows[1];
        const firstRowCells = firstRow.getElementsByTagName('td');
        const firstRowCellContents = firstRowCells[column].textContent.trim();
        const firstRowCellValue    = firstRowCellContents .split('\n')[0];
        // Get the value contained in the selected column - last data row
        const lastRow = rows[rows.length - 1];
        const lastRowCells = lastRow.getElementsByTagName('td');
        const lastRowCellContents = lastRowCells[column].textContent.trim();
        const lastRowCellValue    = lastRowCellContents .split('\n')[0];
        // save the column sort direction in the script
        if( firstRowCellValue < lastRowCellValue )
        {
            lastToDoSortDir = "up";
        }
        else
        {
            lastToDoSortDir = "down";
        }
    }
    // Sort My Plants table by previous sort criteria
    window.onload = restoreToDoSort();

    //======================================================================
    // Define ToDo class
    //======================================================================
    let todoItems = [];

    // class ToDo
    // {   
    //     constructor(status, date, myplant, action, repeat, details) 
    //     {
    //         this.status  = status;
    //         this.date    = date;
    //         this.myplant = myplant;
    //         this.action  = action;
    //         this.repeat  = repeat;
    //         this.details = details;
    //     }
    // } 

    // On page load fetch the user's To Do items and put into list of todo objects
    function fetchToDoItems()
    {
        const url = "{% url 'plants:myplants_todo_fetch' %}"
        const requestMethod = "POST";
        const csrfToken     = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(url,
        {
            method: requestMethod,
            headers: 
            {
                //  Provides CSRF protection, necessary for Django
                'X-CSRFToken' : csrfToken
            },
        })
        .then(response => response.text())
        .then(todoItemsJSON => 
        {
            // Convert JSON to a list of ToDo objects
            todoItems = JSON.parse(todoItemsJSON);
        })
        .then(render => renderCalendar())
    }
    
    // Create calendar view
    const monthYearDisplay = document.getElementById('monthYear');
    const calendarDates    = document.getElementById('calendarDates');
    const prevMonthBtn     = document.getElementById('prevMonth');
    const nextMonthBtn     = document.getElementById('nextMonth');

    let currentDate = new Date(); // Stores the currently displayed date
    
    function renderCalendar() 
    {
        calendarDates.innerHTML = ''; // Clear previous dates

        const year  = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthYearDisplay.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth  = new Date(year, month + 1, 0);
        const daysInMonth     = lastDayOfMonth.getDate();
        const firstDayIndex   = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

        let todoItemYear  = "";
        let todoItemMonth = "";
        let todoItemDay   = "";

        // Fill in leading empty cells for days before the 1st of the month
        for (let i = 0; i < firstDayIndex; i++) 
        {
            const emptyDiv = document.createElement('div');
            calendarDates.appendChild(emptyDiv);
        }
        // Populate dates
        for (let day = 1; day <= daysInMonth; day++) 
        {
            const dateDiv = document.createElement('div');
            let date_text = "";
            date_text = day;

            // Check if any todo items correspond to the date being processed
            // for(todoItem in todoItems)
            for(i=0; i <= todoItems.length-1; i++)
            {
                todoItemDate  = todoItems[i].date;
                todoItemYear  = todoItemDate.substring(0,  4);
                todoItemMonth = todoItemDate.substring(5,  7);  
                todoItemDay   = todoItemDate.substring(8, 10);

                if(day == todoItemDay && month + 1 == todoItemMonth && year == todoItemYear)
                {
                    date_text = date_text + 
                                "</br>" + 
                                "<span style='cursor:pointer;' onclick='todo_details(" + todoItems[i].id + ")'>" +
                                todoItems[i].action + ": " + todoItems[i].commonName +
                                "</span>";
                }
            }
            dateDiv.innerHTML = date_text;
                                  
            // Highlight today's date
            if (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) 
            {
                dateDiv.classList.add('today');
            }
            calendarDates.appendChild(dateDiv);
        }
    }

    // Event listeners for month navigation
    prevMonthBtn.addEventListener('click', () => 
    {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => 
    {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // Fetch all ToDo items for current user 
    window.onload = fetchToDoItems();
</script>
{% endblock js %}